<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Az Captain Time Cycle Dashboard</title>
    <link rel="icon" href="https://imgbed.captainzeqi.com/file/1758348585439_%E9%BB%91%E7%99%BD%E8%B7%AF%E9%A3%9E%E9%80%8F%E6%98%8E%E8%83%8C%E6%99%AF.png" type="image/png">
    
    <style>
        /* --- 1. V7 风格：双主题系统 --- */
        
        /* [data-theme="light"] (明亮主题) */
        [data-theme="light"] {
            --color-bg: #ffffff;           /* 白色 (背景) */
            --color-surface: #f4f7f6;      /* 浅灰 (表面) */
            --color-text: #0a192f;         /* 深蓝 (主文字) */
            --color-text-muted: #555;      /* 灰色 (次要文字) */
            --color-primary: #007bff;      /* 蓝色 (主色调) */
            --color-primary-dark: #0056b3; /* 蓝色 (深) */
            --color-border: #ddd;          /* 边框色 */
            --color-danger: #f44336;       /* 删除按钮 */
            --color-today-bg: #fffbe6;     /* "今天"高亮背景 */
            --color-today-border: #ffe58f;
        }

        /* [data-theme="dark"] (黑暗/科技感主题) */
        [data-theme="dark"] {
            --color-bg: #0a192f;           /* 深海军蓝 (背景) */
            --color-surface: #1e2a47;      /* 石墨蓝 (表面) */
            --color-text: #e6f1ff;         /* 亮白/浅蓝 (主文字) */
            --color-text-muted: #8892b0;   /* 灰蓝 (次要文字) */
            --color-primary: #64ffda;      /* 高亮青色 (主色调) */
            --color-primary-dark: #13a08f; /* 主色调 (深) */
            --color-border: #303c5a;       /* 边框色 */
            --color-danger: #f44336;       /* 删除按钮 */
            --color-today-bg: rgba(100, 255, 218, 0.1); /* "今天"高亮背景 */
            --color-today-border: var(--color-primary);
        }

        /* --- 全局重置 --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            overflow: hidden; 
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- 2. 布局：100vh 主容器 --- */
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- 3. 头部 (导入/导出/主题) --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 30px;
            background-color: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            flex-shrink: 0;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            position: relative;
            z-index: 10;
        }
        header h1 {
            margin: 0;
            font-size: 22px;
            letter-spacing: 0.04em;
            color: var(--color-primary);
            transition: color 0.3s ease;
        }
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #import-file { display: none; }

        /* --- 4. 主内容区 (表单 + 列表) --- */
        .project-management-full {
            flex-grow: 1; 
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 18px;
            padding: 18px 20px 20px;
            overflow: hidden; 
        }

        .section-box {
            background-color: var(--color-surface);
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.05);
            padding: 18px 18px 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
            border: 1px solid rgba(0,0,0,0.02);
        }
        .section-box:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(0,0,0,0.08);
        }
        [data-theme="dark"] .section-box {
            box-shadow: 0 4px 16px rgba(0,0,0,0.35);
            border-color: rgba(255,255,255,0.04);
        }
        
        .section-box h3 {
            border-bottom: 2px solid rgba(0,0,0,0.03);
            padding-bottom: 10px;
            margin-bottom: 16px;
            color: var(--color-text);
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* --- 4.1 表单 --- */
        .project-form-container {
            overflow-y: auto;
        }
        #project-form .form-group {
            margin-bottom: 14px;
        }
        #project-form label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
            color: var(--color-text-muted);
            transition: color 0.3s ease;
        }

        /* --- 4.2 列表 + 数量 --- */
        .project-list-container {
            padding: 0; 
        }
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 18px 0 18px;
            margin-bottom: 4px;
        }
        .list-header h3 {
            margin: 0;
            border: none;
            padding: 0;
            font-size: 15px;
        }
        /* 数量 badge */
        #project-count-span {
            color: var(--color-text-muted);
            font-weight: 400;
            font-size: 13px;
            margin-left: 8px;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid var(--color-border);
            background-color: rgba(0,0,0,0.01);
        }
        #search-box {
            width: 240px;
        }
        
        .table-wrapper {
            flex-grow: 1;
            overflow-y: auto; 
            padding: 10px 18px 16px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            border-bottom: 1px solid var(--color-border);
            padding: 9px 10px;
            text-align: left;
            vertical-align: middle;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }
        th {
            background-color: var(--color-surface);
            color: var(--color-text-muted);
            position: sticky;
            top: 0;
            z-index: 1;
            font-weight: 600;
            font-size: 12px;
        }
        tbody tr:nth-child(even) {
            background-color: rgba(0,0,0,0.01);
        }
        [data-theme="dark"] tbody tr:nth-child(even) {
            background-color: rgba(255,255,255,0.02);
        }
        tr:hover {
            background-color: var(--color-today-bg);
        }
        td .delete-btn {
            background: var(--color-danger);
            border-color: var(--color-danger);
            color: #fff;
        }
        td .delete-btn:hover {
            color: #fff;
            background-color: #c82333;
            border-color: #c82333;
        }
        
        /* --- 5. 按钮 --- */
        button {
            cursor: pointer;
            padding: 8px 14px;
            border: 1px solid var(--color-primary);
            background-color: var(--color-primary);
            color: var(--color-bg); 
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        [data-theme="light"] button {
            color: #fff;
        }
        button:hover {
            background-color: var(--color-primary-dark);
            border-color: var(--color-primary-dark);
            box-shadow: 0 0 10px var(--color-primary);
            transform: translateY(-0.5px);
        }
        button.secondary {
            background-color: transparent;
            color: var(--color-primary);
            border: 1px solid rgba(0,0,0,0.06);
        }
        [data-theme="dark"] button.secondary {
            border-color: rgba(255,255,255,0.16);
        }
        button.secondary:hover {
            background-color: var(--color-today-bg);
            box-shadow: none;
        }
        
        button:disabled {
            background-color: var(--color-text-muted);
            border-color: var(--color-text-muted);
            color: var(--color-surface);
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: none;
            transform: none;
        }
        button.secondary:disabled {
            background-color: transparent;
            border-color: var(--color-text-muted);
            color: var(--color-text-muted);
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* --- 输入框 --- */
        input[type="text"], input[type="date"], input[type="number"], textarea {
            width: 100%;
            padding: 9px 10px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            background-color: var(--color-bg);
            color: var(--color-text);
            font-size: 13px;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.2s ease;
        }
        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 1px rgba(100, 255, 218, 0.25);
        }
        [data-theme="light"] input[type="date"]::-webkit-calendar-picker-indicator {
            filter: none;
        }
        [data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        /* --- 进度条单元格 --- */
        .progress-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
        }
        .progress-bar-outer {
            flex: 1;
            height: 8px;
            border-radius: 999px;
            background: rgba(0,0,0,0.06);
            overflow: hidden;
        }
        [data-theme="dark"] .progress-bar-outer {
            background: rgba(255,255,255,0.08);
        }
        .progress-bar-inner {
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(90deg, var(--color-primary-dark), var(--color-primary));
            transition: width 0.25s ease;
        }
        .progress-text {
            font-size: 11px;
            color: var(--color-text-muted);
            min-width: 32px;
            text-align: right;
        }

        /* --- 6. 页脚 --- */
        footer {
            flex-shrink: 0;
            padding: 10px;
            text-align: center;
            font-size: 12px;
            color: var(--color-text-muted);
            background-color: var(--color-surface);
            border-top: 1px solid var(--color-border);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* --- 7. 时间轴弹窗 (Modal) --- */
        #open-timeline-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 50;
            padding: 12px 20px;
            font-size: 14px;
            box-shadow: 0 5px 15px var(--color-primary);
        }
        [data-theme="light"] #open-timeline-btn {
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }
        [data-theme="dark"] #open-timeline-btn {
            box-shadow: 0 5px 15px rgba(100, 255, 218, 0.3);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .timeline-content {
            width: 95%;
            height: 95%;
            background: var(--color-bg);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        /* --- 8. 时间轴控制区 --- */
        #timeline-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background-color: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            flex-shrink: 0;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #timeline-controls .view-toggles,
        #timeline-controls .navigation {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #current-view-label {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            color: var(--color-primary);
            transition: color 0.3s ease;
        }
        #close-timeline-btn {
            background: none;
            border: none;
            color: var(--color-text-muted);
            font-size: 24px;
            font-weight: bold;
            padding: 0 8px;
        }
        #close-timeline-btn:hover {
            color: var(--color-primary);
            background: none;
            box-shadow: none;
            transform: none;
        }

        /* --- 9. 时间轴看板 --- */
        #timeline-kanban {
            overflow: auto; 
            padding: 16px 18px 18px;
            flex-grow: 1;
        }
        .timeline-grid {
            min-width: 1200px;
        }
        .timeline-header {
            display: grid;
            grid-template-columns: 220px 1fr; 
            position: sticky;
            top: 0;
            background: var(--color-bg);
            z-index: 10;
            border-bottom: 2px solid var(--color-border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .timeline-header .header-name {
            padding: 8px 10px;
            font-weight: 600;
            border-right: 1px solid var(--color-border);
            text-align: center;
            color: var(--color-text-muted);
            font-size: 12px;
        }
        .timeline-header-dates {
            display: grid;
        }
        .timeline-header-cell {
            padding: 8px 4px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            border-right: 1px dotted var(--color-border);
            color: var(--color-text-muted);
        }
        .timeline-header-cell.today {
            background-color: var(--color-today-bg);
            border-left: 1px solid var(--color-today-border);
            border-right: 1px solid var(--color-today-border);
            color: var(--color-primary);
        }

        .timeline-body .project-row {
            display: grid;
            grid-template-columns: 220px 1fr;
            border-bottom: 1px solid var(--color-border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        [data-theme="light"] .project-row:nth-child(even) {
            background-color: var(--color-surface);
        }
        [data-theme="dark"] .project-row:nth-child(even) {
            background-color: rgba(30, 42, 71, 0.5);
        }
        .project-row .project-name {
            padding: 12px 10px;
            font-size: 13px;
            font-weight: 500;
            border-right: 1px solid var(--color-border);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--color-text);
        }
        .project-row .project-bar-wrapper {
            position: relative;
            height: 46px; 
        }
        .project-bar {
            position: absolute;
            top: 9px;
            height: 28px;
            background-color: var(--color-primary);
            border: 1px solid var(--color-primary-dark);
            border-radius: 999px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            color: var(--color-bg);
            font-size: 11px;
            font-weight: 600;
            padding: 0 10px;
            line-height: 28px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        [data-theme="light"] .project-bar {
            color: #fff;
        }
        .project-bar:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.35);
        }
    </style>
</head>
<body>

    <div class="main-container">

        <header>
            <h1>Az Captain Time Cycle Dashboard</h1>
            <div class="header-controls">
                <button id="theme-toggle-btn" class="secondary">切换主题</button>
                <button id="export-btn">导出 .JSON</button>
                <button id="import-btn" class="secondary">导入 .JSON</button>
                <input type="file" id="import-file" accept=".json">
            </div>
        </header>

        <section class="project-management-full">
            
            <div id="project-form-container" class="section-box project-form-container">
                <h3>添加/编辑项目</h3>
                <form id="project-form">
                    <input type="hidden" id="project-id">
                    <div class="form-group">
                        <label for="project-name">项目名称</label>
                        <input type="text" id="project-name" required>
                    </div>
                    <div class="form-group">
                        <label for="start-date">开始时间</label>
                        <input type="date" id="start-date" required>
                    </div>
                    <div class="form-group">
                        <label for="cycle-days">周期天数</label>
                        <input type="number" id="cycle-days" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label for="end-date">结束时间</label>
                        <input type="date" id="end-date" required>
                    </div>
                    <div class="form-group">
                        <label for="notes">备注</label>
                        <textarea id="notes" rows="3"></textarea>
                    </div>
                    <button type="submit">保存项目</button>
                </form>
            </div>
            
            <div class="project-list-container section-box">
                <div class="list-header">
                    <h3>项目列表 <span id="project-count-span">(0)</span></h3>
                    <input type="text" id="search-box" placeholder="搜索项目名称、备注...">
                </div>
                <div class="table-wrapper">
                    <table id="project-list-table">
                        <thead>
                            <tr>
                                <th>项目名称</th>
                                <th>开始时间</th>
                                <th>周期(天)</th>
                                <th>结束时间</th>
                                <th>进度</th>
                                <th>备注</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="project-list-body">
                        </tbody>
                    </table>
                </div>
            </div>

        </section>

        <footer id="page-footer">
            @time.haloninja.com
        </footer>

        <button id="open-timeline-btn">查看看板</button>

    </div>


    <div id="timeline-modal" class="modal-overlay hidden">
        <div class="timeline-content">
            
            <section id="timeline-controls">
                <div class="navigation">
                    <button id="prev-btn">◀ 上一页</button>
                    <button id="today-btn" class="secondary">今天</button>
                    <button id="next-btn">下一页 ▶</button>
                </div>

                <h3 id="current-view-label">2025年 11月</h3>
                
                <div class="view-toggles">
                    <button class="view-btn secondary" data-view="year">年</button>
                    <button class="view-btn" data-view="month">月</button>
                    <button class="view-btn secondary" data-view="week">周</button>
                    <button class="view-btn secondary" data-view="day">日</button>
                    <button id="close-timeline-btn" title="关闭">×</button>
                </div>
            </section>

            <section id="timeline-kanban">
                <div class="timeline-grid">
                    <div class="timeline-header">
                        <div class="header-name">项目</div>
                        <div class="timeline-header-dates" id="timeline-header-dates"></div>
                    </div>
                    <div class="timeline-body" id="timeline-body"></div>
                </div>
            </section>

        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- 1. DOM 引用 ---
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const projectCountSpan = document.getElementById('project-count-span');
        const projectForm = document.getElementById('project-form');
        const projectIdInput = document.getElementById('project-id');
        const projectNameInput = document.getElementById('project-name');
        const startDateInput = document.getElementById('start-date');
        const cycleDaysInput = document.getElementById('cycle-days');
        const endDateInput = document.getElementById('end-date');
        const notesInput = document.getElementById('notes');
        const projectListBody = document.getElementById('project-list-body');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const importFile = document.getElementById('import-file');
        const pageFooter = document.getElementById('page-footer');
        const searchBox = document.getElementById('search-box'); 
        const openTimelineBtn = document.getElementById('open-timeline-btn'); 
        const closeTimelineBtn = document.getElementById('close-timeline-btn'); 
        const timelineModal = document.getElementById('timeline-modal'); 
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const todayBtn = document.getElementById('today-btn');
        const viewBtns = document.querySelectorAll('.view-btn');
        const currentViewLabel = document.getElementById('current-view-label');
        const timelineHeaderDates = document.getElementById('timeline-header-dates');
        const timelineBody = document.getElementById('timeline-body');

        // --- 2. 全局状态 ---
        let state = {
            projects: [],
            currentDate: new Date(),
            currentView: 'month'
        };

        // --- 3. 日期辅助函数 ---
        const MS_PER_DAY = 1000 * 60 * 60 * 24;
        function parseDate(dateStr) { const [y, m, d] = dateStr.split('-').map(Number); return new Date(y, m - 1, d); }
        function formatDate(date) { return date.toISOString().split('T')[0]; }
        function addDays(date, days) { const n = new Date(date.getTime()); n.setDate(n.getDate() + days); return n; }
        function addMonths(date, months) { const d = new Date(date); d.setDate(1); d.setMonth(d.getMonth() + months); return d;}
        function addYears(date, years) { const n = new Date(date.getTime()); n.setFullYear(n.getFullYear() + years); return n; }
        function getDaysDiff(d1, d2) { const d_1 = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate()); const d_2 = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate()); return Math.round((d_1 - d_2) / MS_PER_DAY); }
        function getDaysInMonth(date) { return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate(); }
        function getStartOfWeek(date) { const d = new Date(date); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(d.setDate(diff)); }
        function getStartOfMonth(date) { return new Date(date.getFullYear(), date.getMonth(), 1); }
        function getStartOfYear(date) { return new Date(date.getFullYear(), 0, 1); }

        // 3.1 进度百分比计算（0~100，基于今天）
        function getProgressPercent(project) {
            try {
                const today = new Date();
                const start = parseDate(project.start);
                const end = parseDate(project.end);
                if (!(start instanceof Date) || !(end instanceof Date) || isNaN(start) || isNaN(end)) return 0;

                const totalDays = getDaysDiff(end, start) + 1;
                if (totalDays <= 0) return 0;

                if (today < start) return 0;
                if (today > end) return 100;

                const doneDays = getDaysDiff(today, start) + 1;
                const percent = Math.round((doneDays / totalDays) * 100);
                return Math.max(0, Math.min(100, percent));
            } catch (e) {
                return 0;
            }
        }

        // --- 4. 状态管理 (LocalStorage) ---
        function saveState() { localStorage.setItem('timelineProjects', JSON.stringify(state.projects)); }
        function loadState() { const p = localStorage.getItem('timelineProjects'); if (p) state.projects = JSON.parse(p); }

        // --- 5. 渲染主视图 (列表 + 搜索 + 进度) ---
        function renderMainView() {
            projectListBody.innerHTML = '';
            
            const filterText = searchBox.value.toLowerCase();
            const filteredProjects = state.projects.filter(p => 
                p.name.toLowerCase().includes(filterText) || 
                p.notes.toLowerCase().includes(filterText) ||
                p.start.includes(filterText) ||
                p.end.includes(filterText)
            );

            if (filterText) {
                projectCountSpan.textContent = `(${filteredProjects.length} / ${state.projects.length})`;
            } else {
                projectCountSpan.textContent = `(${state.projects.length})`;
            }

            if (filteredProjects.length === 0) {
                projectListBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px 0; color: var(--color-text-muted); font-size:12px;">暂无项目，右侧可新增一个项目开始你的时间看板。</td></tr>';
                return;
            }

            filteredProjects.forEach(p => {
                const progress = getProgressPercent(p);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.name}</td>
                    <td>${p.start}</td>
                    <td>${p.days}</td>
                    <td>${p.end}</td>
                    <td>
                        <div class="progress-cell">
                            <div class="progress-bar-outer">
                                <div class="progress-bar-inner" style="width: ${progress}%;"></div>
                            </div>
                            <span class="progress-text">${progress}%</span>
                        </div>
                    </td>
                    <td>${p.notes}</td>
                    <td>
                        <button class="edit-btn secondary" data-id="${p.id}">编辑</button>
                        <button class="delete-btn" data-id="${p.id}">删除</button>
                    </td>
                `;
                projectListBody.appendChild(tr);
            });
        }

        // --- 5.2 渲染弹窗视图 (时间轴) ---
        function renderModalView() {
            timelineHeaderDates.innerHTML = '';
            timelineBody.innerHTML = '';
            
            viewBtns.forEach(btn => {
                if (btn.dataset.view) {
                    btn.classList.toggle('secondary', btn.dataset.view !== state.currentView);
                }
            });

            [prevBtn, nextBtn, todayBtn].forEach(btn => btn.disabled = false);

            switch (state.currentView) {
                case 'day': renderDayView(); break;
                case 'week': renderWeekView(); break;
                case 'month': renderMonthView(); break;
                case 'year': renderYearView(); break;
            }
        }

        function renderDayView() {
            const today = state.currentDate;
            const viewStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const viewEnd = addDays(viewStart, 1);
            currentViewLabel.textContent = `${today.getFullYear()}年 ${today.getMonth() + 1}月 ${today.getDate()}日`;
            timelineHeaderDates.style.gridTemplateColumns = `repeat(24, 1fr)`;
            for (let i = 0; i < 24; i++) {
                const cell = document.createElement('div');
                cell.className = 'timeline-header-cell';
                cell.textContent = `${String(i).padStart(2, '0')}:00`;
                timelineHeaderDates.appendChild(cell);
            }
            renderProjectBars(viewStart, viewEnd, 'hour');
        }
        function renderWeekView() {
            const weekStart = getStartOfWeek(state.currentDate);
            const viewStart = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate());
            const viewEnd = addDays(viewStart, 7);
            currentViewLabel.textContent = `${weekStart.getFullYear()}年 ${weekStart.getMonth() + 1}月 ${weekStart.getDate()}日 - ${addDays(weekStart, 6).getDate()}日`;
            timelineHeaderDates.style.gridTemplateColumns = `repeat(7, 1fr)`;
            const today = new Date();
            for (let i = 0; i < 7; i++) {
                const day = addDays(weekStart, i);
                const cell = document.createElement('div');
                cell.className = 'timeline-header-cell';
                cell.textContent = `${day.getMonth() + 1}/${day.getDate()}`;
                if (getDaysDiff(day, today) === 0) cell.classList.add('today');
                timelineHeaderDates.appendChild(cell);
            }
            renderProjectBars(viewStart, viewEnd, 'day');
        }
        function renderMonthView() {
            const monthStart = getStartOfMonth(state.currentDate);
            const daysInMonth = getDaysInMonth(monthStart);
            const viewStart = new Date(monthStart.getFullYear(), monthStart.getMonth(), monthStart.getDate());
            const viewEnd = addDays(viewStart, daysInMonth);
            currentViewLabel.textContent = `${monthStart.getFullYear()}年 ${monthStart.getMonth() + 1}月`;
            timelineHeaderDates.style.gridTemplateColumns = `repeat(${daysInMonth}, 1fr)`;
            const today = new Date();
            for (let i = 1; i <= daysInMonth; i++) {
                const day = new Date(monthStart.getFullYear(), monthStart.getMonth(), i);
                const cell = document.createElement('div');
                cell.className = 'timeline-header-cell';
                cell.textContent = i;
                if (getDaysDiff(day, today) === 0) cell.classList.add('today');
                timelineHeaderDates.appendChild(cell);
            }
            renderProjectBars(viewStart, viewEnd, 'day');
        }
        function renderYearView() {
            const yearStart = getStartOfYear(state.currentDate);
            const viewStart = new Date(yearStart.getFullYear(), 0, 1);
            const viewEnd = addYears(viewStart, 1);
            currentViewLabel.textContent = `${yearStart.getFullYear()}年`;
            timelineHeaderDates.style.gridTemplateColumns = `repeat(12, 1fr)`;
            const months = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
            const today = new Date();
            for (let i = 0; i < 12; i++) {
                const cell = document.createElement('div');
                cell.className = 'timeline-header-cell';
                cell.textContent = months[i];
                if (today.getFullYear() === yearStart.getFullYear() && today.getMonth() === i) cell.classList.add('today');
                timelineHeaderDates.appendChild(cell);
            }
            renderProjectBars(viewStart, viewEnd, 'month');
        }

        // 渲染项目条（带进度文本）
        function renderProjectBars(viewStart, viewEnd, unit) {
            const viewDuration = viewEnd.getTime() - viewStart.getTime();
            state.projects.forEach(project => {
                const projStart = parseDate(project.start);
                const projEnd = parseDate(project.end);
                if (projEnd.getTime() < viewStart.getTime() || projStart.getTime() > viewEnd.getTime()) return;

                const barStart = Math.max(projStart.getTime(), viewStart.getTime());
                const barEnd = Math.min(projEnd.getTime() + MS_PER_DAY, viewEnd.getTime());
                const left = ((barStart - viewStart.getTime()) / viewDuration) * 100;
                const width = ((barEnd - barStart) / viewDuration) * 100;

                const progress = getProgressPercent(project);

                const row = document.createElement('div');
                row.className = 'project-row';
                row.innerHTML = `
                    <div class="project-name">${project.name}</div>
                    <div class="project-bar-wrapper">
                        <div class="project-bar" style="left: ${left}%; width: ${width}%;" 
                             title="${project.name}
开始: ${project.start}
结束: ${project.end}
进度: ${progress}%
备注: ${project.notes}">
                            ${project.name} (${progress}%)
                        </div>
                    </div>`;
                timelineBody.appendChild(row);
            });
        }
        
        // --- 6. 事件处理 ---

        // 表单提交 (添加/更新)
        projectForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = projectIdInput.value;
            const projectData = {
                name: projectNameInput.value,
                start: startDateInput.value,
                days: parseInt(cycleDaysInput.value),
                end: endDateInput.value,
                notes: notesInput.value,
            };
            if (id) {
                const index = state.projects.findIndex(p => p.id === id);
                if (index !== -1) state.projects[index] = { ...state.projects[index], ...projectData };
            } else {
                projectData.id = Date.now().toString();
                state.projects.push(projectData);
            }
            saveState();
            renderMainView();
            projectForm.reset();
            projectIdInput.value = '';
            initFormDates();
        });

        // 自动计算 (三向关联)
        function calculateEndDate() {
            if (!startDateInput.value || !cycleDaysInput.value) return;
            const startDate = parseDate(startDateInput.value);
            let days = parseInt(cycleDaysInput.value);
            if (days < 1) { days = 1; cycleDaysInput.value = 1; }
            const endDate = addDays(startDate, days - 1);
            endDateInput.value = formatDate(endDate);
        }
        function calculateCycleDays() {
            if (!startDateInput.value || !endDateInput.value) return;
            const startDate = parseDate(startDateInput.value);
            const endDate = parseDate(endDateInput.value);
            if (endDate.getTime() < startDate.getTime()) {
                endDateInput.value = startDateInput.value;
                cycleDaysInput.value = 1;
                return;
            }
            const diff = getDaysDiff(endDate, startDate);
            cycleDaysInput.value = diff + 1;
        }
        startDateInput.addEventListener('change', calculateEndDate);
        cycleDaysInput.addEventListener('input', calculateEndDate);
        endDateInput.addEventListener('change', calculateCycleDays);

        // 列表中的编辑/删除
        projectListBody.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            if (!id) return;
            if (e.target.classList.contains('delete-btn')) {
                if (confirm('确定要删除这个项目吗？')) {
                    state.projects = state.projects.filter(p => p.id !== id);
                    saveState();
                    renderMainView();
                }
            } else if (e.target.classList.contains('edit-btn')) {
                const project = state.projects.find(p => p.id === id);
                if (project) {
                    projectIdInput.value = project.id;
                    projectNameInput.value = project.name;
                    startDateInput.value = project.start;
                    cycleDaysInput.value = project.days;
                    endDateInput.value = project.end;
                    notesInput.value = project.notes;
                }
            }
        });

        // 导入/导出
        exportBtn.addEventListener('click', () => {
            const today = new Date();
            const dateString = formatDate(today).replace(/-/g, ''); 
            const filename = `time${dateString}.json`;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.projects, null, 2));
            const a = document.createElement('a');
            a.setAttribute("href", dataStr);
            a.setAttribute("download", filename); 
            document.body.appendChild(a);
            a.click();
            a.remove();
        });
        importBtn.addEventListener('click', () => { importFile.click(); });
        importFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedProjects = JSON.parse(event.target.result);
                    if (Array.isArray(importedProjects)) {
                        state.projects = importedProjects;
                        saveState();
                        renderMainView();
                        alert('导入成功！');
                    } else { alert('导入失败：JSON 文件格式不正确。'); }
                } catch (err) { alert('导入失败：' + err.message); }
                importFile.value = '';
            };
            reader.readAsText(file);
        });
        
        // 弹窗控制
        openTimelineBtn.addEventListener('click', () => {
            timelineModal.classList.remove('hidden');
            renderModalView(); 
        });
        closeTimelineBtn.addEventListener('click', () => {
            timelineModal.classList.add('hidden');
        });

        // 搜索
        searchBox.addEventListener('input', renderMainView);

        // 视图切换
        viewBtns.forEach(btn => {
            if(btn.id === 'close-timeline-btn') return;
            btn.addEventListener('click', () => {
                state.currentView = btn.dataset.view; 
                renderModalView();
            });
        });

        // 导航
        prevBtn.addEventListener('click', () => navigate(-1));
        nextBtn.addEventListener('click', () => navigate(1));
        todayBtn.addEventListener('click', () => navigate(0));
        function navigate(direction) {
            if (direction === 0) {
                state.currentDate = new Date();
            } else {
                switch (state.currentView) {
                    case 'day': state.currentDate = addDays(state.currentDate, direction); break;
                    case 'week': state.currentDate = addDays(state.currentDate, direction * 7); break;
                    case 'month': state.currentDate = addMonths(state.currentDate, direction); break;
                    case 'year': state.currentDate = addYears(state.currentDate, direction); break;
                }
            }
            renderModalView();
        }

        // 主题切换
        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });

        // 初始化
        function initFormDates() {
            startDateInput.value = formatDate(new Date());
            calculateEndDate();
        }
        
        function initFooter() {
            const host = window.location.host || 'time.haloninja.com';
            pageFooter.textContent = `@${host}`;
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        function init() {
            loadTheme();
            loadState();
            renderMainView(); 
            initFormDates();
            initFooter();
        }

        init();
    });
    </script>
</body>
</html>
